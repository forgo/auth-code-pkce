name: E2E Framework Matrix

on:
  workflow_dispatch:
    inputs:
      force-bypass-cache:
        description: 'Force run all tests even if cache indicates pass'
        required: false
        type: boolean
        default: false
  schedule:
    # Run nightly at 2 AM UTC
    - cron: '0 2 * * *'

concurrency:
  group: ${{ github.workflow }}-${{ github.ref }}
  cancel-in-progress: true

jobs:
  # React framework tests
  react-keycloak-v25:
    uses: ./.github/workflows/e2e-framework.yml
    with:
      framework: react
      provider: keycloak
      version: v25
      port: '8025'
      image: quay.io/keycloak/keycloak:25.0.6
      provider_url: http://localhost:8025
      force-bypass-cache: ${{ inputs.force-bypass-cache || false }}

  react-keycloak-v26:
    uses: ./.github/workflows/e2e-framework.yml
    with:
      framework: react
      provider: keycloak
      version: v26
      port: '8026'
      image: quay.io/keycloak/keycloak:26.0.7
      provider_url: http://localhost:8026
      force-bypass-cache: ${{ inputs.force-bypass-cache || false }}

  react-authentik-v2024-8:
    uses: ./.github/workflows/e2e-framework.yml
    with:
      framework: react
      provider: authentik
      version: v2024-8
      port: '9024'
      image: ghcr.io/goauthentik/server:2024.8.3
      provider_url: http://localhost:9024
      force-bypass-cache: ${{ inputs.force-bypass-cache || false }}

  react-authentik-v2024-12:
    uses: ./.github/workflows/e2e-framework.yml
    with:
      framework: react
      provider: authentik
      version: v2024-12
      port: '9025'
      image: ghcr.io/goauthentik/server:2024.12.1
      provider_url: http://localhost:9025
      force-bypass-cache: ${{ inputs.force-bypass-cache || false }}

  react-authentik-v2025-6:
    uses: ./.github/workflows/e2e-framework.yml
    with:
      framework: react
      provider: authentik
      version: v2025-6
      port: '9026'
      image: ghcr.io/goauthentik/server:2025.6.0
      provider_url: http://localhost:9026
      force-bypass-cache: ${{ inputs.force-bypass-cache || false }}

  # Vue framework tests
  vue-keycloak-v25:
    uses: ./.github/workflows/e2e-framework.yml
    with:
      framework: vue
      provider: keycloak
      version: v25
      port: '8025'
      image: quay.io/keycloak/keycloak:25.0.6
      provider_url: http://localhost:8025
      force-bypass-cache: ${{ inputs.force-bypass-cache || false }}

  vue-keycloak-v26:
    uses: ./.github/workflows/e2e-framework.yml
    with:
      framework: vue
      provider: keycloak
      version: v26
      port: '8026'
      image: quay.io/keycloak/keycloak:26.0.7
      provider_url: http://localhost:8026
      force-bypass-cache: ${{ inputs.force-bypass-cache || false }}

  vue-authentik-v2024-8:
    uses: ./.github/workflows/e2e-framework.yml
    with:
      framework: vue
      provider: authentik
      version: v2024-8
      port: '9024'
      image: ghcr.io/goauthentik/server:2024.8.3
      provider_url: http://localhost:9024
      force-bypass-cache: ${{ inputs.force-bypass-cache || false }}

  vue-authentik-v2024-12:
    uses: ./.github/workflows/e2e-framework.yml
    with:
      framework: vue
      provider: authentik
      version: v2024-12
      port: '9025'
      image: ghcr.io/goauthentik/server:2024.12.1
      provider_url: http://localhost:9025
      force-bypass-cache: ${{ inputs.force-bypass-cache || false }}

  vue-authentik-v2025-6:
    uses: ./.github/workflows/e2e-framework.yml
    with:
      framework: vue
      provider: authentik
      version: v2025-6
      port: '9026'
      image: ghcr.io/goauthentik/server:2025.6.0
      provider_url: http://localhost:9026
      force-bypass-cache: ${{ inputs.force-bypass-cache || false }}

  # Svelte framework tests
  svelte-keycloak-v25:
    uses: ./.github/workflows/e2e-framework.yml
    with:
      framework: svelte
      provider: keycloak
      version: v25
      port: '8025'
      image: quay.io/keycloak/keycloak:25.0.6
      provider_url: http://localhost:8025
      force-bypass-cache: ${{ inputs.force-bypass-cache || false }}

  svelte-keycloak-v26:
    uses: ./.github/workflows/e2e-framework.yml
    with:
      framework: svelte
      provider: keycloak
      version: v26
      port: '8026'
      image: quay.io/keycloak/keycloak:26.0.7
      provider_url: http://localhost:8026
      force-bypass-cache: ${{ inputs.force-bypass-cache || false }}

  svelte-authentik-v2024-8:
    uses: ./.github/workflows/e2e-framework.yml
    with:
      framework: svelte
      provider: authentik
      version: v2024-8
      port: '9024'
      image: ghcr.io/goauthentik/server:2024.8.3
      provider_url: http://localhost:9024
      force-bypass-cache: ${{ inputs.force-bypass-cache || false }}

  svelte-authentik-v2024-12:
    uses: ./.github/workflows/e2e-framework.yml
    with:
      framework: svelte
      provider: authentik
      version: v2024-12
      port: '9025'
      image: ghcr.io/goauthentik/server:2024.12.1
      provider_url: http://localhost:9025
      force-bypass-cache: ${{ inputs.force-bypass-cache || false }}

  svelte-authentik-v2025-6:
    uses: ./.github/workflows/e2e-framework.yml
    with:
      framework: svelte
      provider: authentik
      version: v2025-6
      port: '9026'
      image: ghcr.io/goauthentik/server:2025.6.0
      provider_url: http://localhost:9026
      force-bypass-cache: ${{ inputs.force-bypass-cache || false }}

  # Generate compatibility matrix
  generate-matrix:
    name: Generate Compatibility Matrix
    runs-on: ubuntu-latest
    needs:
      - react-keycloak-v25
      - react-keycloak-v26
      - react-authentik-v2024-8
      - react-authentik-v2024-12
      - react-authentik-v2025-6
      - vue-keycloak-v25
      - vue-keycloak-v26
      - vue-authentik-v2024-8
      - vue-authentik-v2024-12
      - vue-authentik-v2025-6
      - svelte-keycloak-v25
      - svelte-keycloak-v26
      - svelte-authentik-v2024-8
      - svelte-authentik-v2024-12
      - svelte-authentik-v2025-6
    if: always()
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '20'

      - name: Generate Framework Compatibility Matrix
        run: |
          cat > framework-compatibility.md << 'EOF'
          # Framework Compatibility Matrix

          | Framework | Keycloak 25 | Keycloak 26 | Authentik 2024.8 | Authentik 2024.12 | Authentik 2025.6 |
          |-----------|-------------|-------------|------------------|-------------------|------------------|
          | React     | ${{ needs.react-keycloak-v25.outputs.result == 'pass' && '✅' || '❌' }} | ${{ needs.react-keycloak-v26.outputs.result == 'pass' && '✅' || '❌' }} | ${{ needs.react-authentik-v2024-8.outputs.result == 'pass' && '✅' || '❌' }} | ${{ needs.react-authentik-v2024-12.outputs.result == 'pass' && '✅' || '❌' }} | ${{ needs.react-authentik-v2025-6.outputs.result == 'pass' && '✅' || '❌' }} |
          | Vue       | ${{ needs.vue-keycloak-v25.outputs.result == 'pass' && '✅' || '❌' }} | ${{ needs.vue-keycloak-v26.outputs.result == 'pass' && '✅' || '❌' }} | ${{ needs.vue-authentik-v2024-8.outputs.result == 'pass' && '✅' || '❌' }} | ${{ needs.vue-authentik-v2024-12.outputs.result == 'pass' && '✅' || '❌' }} | ${{ needs.vue-authentik-v2025-6.outputs.result == 'pass' && '✅' || '❌' }} |
          | Svelte    | ${{ needs.svelte-keycloak-v25.outputs.result == 'pass' && '✅' || '❌' }} | ${{ needs.svelte-keycloak-v26.outputs.result == 'pass' && '✅' || '❌' }} | ${{ needs.svelte-authentik-v2024-8.outputs.result == 'pass' && '✅' || '❌' }} | ${{ needs.svelte-authentik-v2024-12.outputs.result == 'pass' && '✅' || '❌' }} | ${{ needs.svelte-authentik-v2025-6.outputs.result == 'pass' && '✅' || '❌' }} |

          Generated: $(date -u +"%Y-%m-%d %H:%M:%S UTC")
          EOF

          cat framework-compatibility.md

      - name: Upload compatibility matrix
        uses: actions/upload-artifact@v4
        with:
          name: framework-compatibility-matrix
          path: framework-compatibility.md
          retention-days: 30
